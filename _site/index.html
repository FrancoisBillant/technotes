
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title></title>
    
    <meta name="author" content="Francois Billant">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">Technical Notes</a>
          <ul class="nav">
            
            
            


  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  



          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">
        


  
    <div class="blog-index">  
      
      
      <h2 class="entry-title">


    <a href="/howto/ansible/2015/08/06/managing-iptables-with-ansible">Managing Iptables with Ansible</a>

</h2>
<div class="entry-content">
<h2 id="overiew">Overiew</h2>
<p>First, I am no network expert, so please bare with me or help improve ;)  <br />
The idea here is to manage an iptables firewal “as a code” by using Ansible as a CMS*.</p>

<p>To do so, i will use <a href="http://ferm.foo-projects.org/">Ferm</a> which provide an abstraction over Iptables for a nice rules management. (For information about why I chose this, see <a href="/howto/docker/kvm/2015/08/03/playing-with-ansible-iptables-docker-and-kvm/">here</a>)</p>

<p>*Configuration Management System</p>

<h2 id="requirements">Requirements</h2>
<ul>
  <li>An Ansible workstation (ie <a href="https://registry.hub.docker.com/u/ansible/ubuntu14.04-ansible/">ansible container</a>)</li>
  <li>A target server (tested on debian jessie)</li>
</ul>

<h2 id="details">Details</h2>
<p>After trying a bit, i ended up with a playbook looking like this:</p>

<pre><code>|-site.yml
|-base.yml
|-roles/
    |-base
        |-tasks
            |-main.yml
            |-users.yml
            |-tmux.yml
            |-vim.yml
            |-iptables.yml
        |-handlers
            |-main.yml
        |-files
            |-etc
                |-ferm
                    |-ferm.conf
        |-vars
            |-creds.yml
</code></pre>

<p>It begins with the file <code>site.yml</code>:</p>

<pre><code>- name: apply common configuration to all nodes
  hosts: all
  include: base.yml
</code></pre>

<p>We can see that it <code>include: base.yml</code>:</p>

<pre><code>- hosts: all
  remote_user: root
  roles:
    - base
</code></pre>

<p>Let’s look at the role that is called here <code>roles/base/tasks/main.yml</code>:</p>

<pre><code>- include_vars: creds.yml
- include: users.yml
- include: vim.yml
- include: tmux.yml
- include: iptables.yml
</code></pre>

<p>The last line call the file <code>roles/base/tasks/iptables.yml</code> which contain the actual plays:</p>

<pre><code>---
- name: Install ferm
  apt:
    name=ferm
    state=present

- name: Add ferm config directory
  file:
    path=/etc/ferm
    state=directory
    owner=root group=root mode=0700

- name: Add ferm config directory for additional config files
  file:
    path=/etc/ferm/ferm.d
    state=directory
    owner=root group=root mode=0700

- name: Upload config
  copy:
    dest=/etc/ferm/ferm.conf
    src=etc/ferm/ferm.conf
    owner=root group=root mode=0700
  notify:
    - restart ferm
</code></pre>

<p>As always, I think the yaml content speaks for itself. <br />
The last play (“Upload config”) copy onto the target the Ferm configuration file that can be found in <code>roles/base/files/etc/ferm/ferm.conf</code></p>

<pre><code># ferm basic configuration.

table filter {
    chain INPUT {
        policy DROP;

        # connection tracking
        mod state {
            state INVALID DROP;
            state (RELATED ESTABLISHED) ACCEPT;
        }

        # allow local connections
        interface lo ACCEPT;

        # respond to ping
        proto icmp ACCEPT;

        # allow SSH connections
        proto tcp dport ssh ACCEPT;
    }

    # outgoing connections are not limited
    chain OUTPUT {
        policy ACCEPT;

        # connection tracking
        mod state {
            state INVALID DROP;
            state (RELATED ESTABLISHED) ACCEPT;
        }
    }

    # this is not a router
    chain FORWARD {
        policy DROP;

        # connection tracking
        mod state {
            state INVALID DROP;
            state (RELATED ESTABLISHED) ACCEPT;
        }
    }
}

@include 'ferm.d/';
</code></pre>

<p>This a very basic configuration that let everything out, nothing in except ssh on port 22 and nothing to be forwarded. <br />
See <a href="http://ferm.foo-projects.org/download/2.2/ferm.html">Ferm documentation</a> for details about ferm.conf.</p>

<p>Note the last line that will include every files in the /etc/ferm/ferm.d directory.  <br />
I will use this so that every application or role can deploys its own sets of iptables rules by copying the appropriate file in this directory. <br />
I will show and example in the next post.</p>

<p>Then the playbook can be run with:</p>

<pre><code>ansible-playbook -i inventory_file site.yml
</code></pre>

<p>If you do not use a key based authentication and need to manually provide the password, you can pass the <code>--ask-pass</code> parameter.</p>
</div>

    </div>
  
    <div class="blog-index">  
      
      
      <h2 class="entry-title">


    <a href="/howto/docker/kvm/ansible/2015/08/03/playing-with-ansible-iptables-docker-and-kvm">Playing with Ansible, Iptables, docker and KVM</a>

</h2>
<div class="entry-content">
<h2 id="overview">Overview</h2>
<p>So I rented myself a box as a sandbox. <br />
Because I do not want to manage “pets” anymore, for starter I want my server to be managed as a code from the ground. Since I already used a little puppet and chef, I though I would use the chance to try and play with Ansible.</p>

<p>Another thing is I hate Docker !!! Because since I started using it more than 1 year ago now, I find dealing with non-containerized applications and environments to be a pain in the back…. <br />
So like on my latptop/desktop, the idea is to put a Debian on baremetal then, install the less applications possible in the system and put everything needed into containers.</p>

<p>The last thing is that I need VMs, so i will use KVM, but I also might use docker on the baremetal machine (in addition of inside some of the VMs…). <br />
So here is a representation of what I would like to build:</p>

<p><img src="/assets/images/homelab.png" alt="Basic Config" title="Basic Config" /></p>

<h2 id="requirements">Requirements</h2>
<ul>
  <li>
    <p>An ansible installation. It can be you laptop, a VM or a container.
  There are 2 officials Ansible images on the dockerhub, an ubuntu based and a centos based: <br />
  <a href="https://registry.hub.docker.com/u/ansible/ubuntu14.04-ansible/">Ansible ubuntu based docker image</a> <br />
  <a href="https://registry.hub.docker.com/u/ansible/centos7-ansible/">Ansible centos based docker image</a></p>

    <p>You can run it with:
      docker run -dti –name ansible -v ~/ansible:/root/share francois/ansible:latest /bin/bash
      docker attach ansible</p>
  </li>
</ul>

<h2 id="details">Details</h2>
<p>So first thing first, let see how ansible can deal with iptables.</p>

<h3 id="iptables">Iptables</h3>
<p>After quite a bit of reading, it seems that managing Iptables with ansible is mainly done by choosing one of this three alternatives:</p>

<ul>
  <li>Managing an iptable.rules file by parsing line by line for content and filter with regex. <br />
  It seems to me that this method could become quite a pain as the file grows.</li>
  <li>Ansible galaxy role: <a href="https://galaxy.ansible.com/list#/roles/920">stout.iptables</a> <br />
  I tried out this one. Very straightforward at first.
  But as i tried to implement the rest of the config (kvm, docker…) it didn’t seems to be a good match, possibly (probably?!) because of my lack of knowledge of the Ansible tool and how to use it best…</li>
  <li>
    <p>Installing <a href="http://ferm.foo-projects.org/">ferm</a> on the host, and using Ansible to manage ferm/iptables configurations
  At first, I didn’t want to use this method because it was forcing me to install ferm on the host. Why the hell should I install an additionnal application to be able to manage my firewall as a code…</p>

    <p>Well, I end up trying because the more read about it, the more it seemed a good fit to the purpose I was trying to achieve. <br />
  And indeed, it is.</p>

    <p>So I will use Ansible to manage Iptables through Ferm.</p>

    <p><a href="/howto/2015/08/06/managing-iptables-with-ansible/">How To</a></p>
  </li>
</ul>

<h3 id="kvm">KVM</h3>
<p>TODO</p>

<h3 id="docker">Docker</h3>
<p>TODO</p>
</div>

    </div>
  
    <div class="blog-index">  
      
      
      <h2 class="entry-title">


    <a href="/howto/2015/08/01/create-a-blog-hosted-on-github-with-jekyll">Create a blog hosted on Github with Jekyll</a>

</h2>
<div class="entry-content">
<h2 id="overview">Overview</h2>

<p>The idea here is to create a blog entirely hosted on github.</p>

<p>To do this I will use:</p>

<ul>
  <li>
    <p>Github pages to version and host the blog: <a href="https://pages.github.com/">https://pages.github.com/</a></p>
  </li>
  <li>
    <p>Jekyll and Jekyll-Bootstrap to create and build the blog: <a href="http://jekyllbootstrap.com/">http://jekyllbootstrap.com/</a></p>
  </li>
</ul>

<h2 id="requirements">Requirements</h2>

<ul>
  <li>a github account</li>
  <li>a place to install Jekyll, be it your laptop, a VM or container. You will need to have internet access to be able to push to github</li>
</ul>

<h2 id="install">Install</h2>
<p>I made available on the docker hub a container including jekyll, git and vim, you can find it here: <a href="https://registry.hub.docker.com/u/francois/jekyll/">https://registry.hub.docker.com/u/francois/jekyll/</a> <br />
Just run it with:</p>

<pre><code>docker run -dti --name jekyll francois/jekyll:latest /bin/bash   
docker attach jekyll
</code></pre>

<p>and you’re good to go :)</p>

<p>Otherwise, look at the Dockerfile for the install process ;) <a href="https://github.com/francois-docker/jekyll/blob/master/Dockerfile">https://github.com/francois-docker/jekyll/blob/master/Dockerfile</a></p>

<h2 id="configuration">Configuration</h2>

<h3 id="github">Github</h3>

<ul>
  <li>Create a new repository
    <ul>
      <li>
        <p>If you want your site url to be: https://USERNAME.github.io:  <br />
  Create a repository called USERNAME.github.io where USERNAME is your github username.</p>
      </li>
      <li>
        <p>If you want your site url to be https://USERNAME.github.io/PROJECT:  <br />
  Create a repository with whatever name you’d like, ie “myblog”</p>
      </li>
      <li>
        <p>If you want to use your own domain name, you can use any of the previous methods</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Go to your workspace (container, vm, laptop…)</p>

    <pre><code>  #Clone the skeleton of the blog   
  git clone https://github.com/plusjade/jekyll-bootstrap.git myblog   
  cd myblog   
  #Change the origin   
  git remote set-url origin git@github.com:USERNAME/myblog.git   
  #Create an orphan branch   
  git checkout --orphan gh-pages
</code></pre>
  </li>
</ul>

<h3 id="blog">Blog</h3>

<ul>
  <li>
    <p>Cleanup</p>

    <p>First, remove examples posts from skeleton</p>

    <pre><code>  rm -Rf _posts/core-samples/
  rm -f _drafts/*
</code></pre>
  </li>
  <li>
    <p>Custom domain</p>

    <ul>
      <li>Case url type: https://USERNAME.github.io
        <ul>
          <li>Your github repo is named USERNAME.github.io</li>
          <li>
            <p>Modify the _config.yml accordingly:</p>

            <pre><code>     production_url : https://USERNAME.github.io 
</code></pre>
          </li>
        </ul>
      </li>
      <li>Case url type: https://USERNAME.github.io/REPO_NAME
        <ul>
          <li>Your github repo is named REPO_NAME</li>
          <li>
            <p>Modify the _config.yml accordingly:</p>

            <pre><code>     production_url : https://USERNAME.github.io/REPO_NAME 
     BASE_PATH : https://USERNAME.github.io/REPO_NAME
</code></pre>
          </li>
        </ul>
      </li>
      <li>Case url type: https://yourblog.yourdomain.tld
        <ul>
          <li>Your github repo is named REPO_NAME</li>
          <li>
            <p>Modify the _config.yml accordingly:</p>

            <pre><code>     production_url : https://yourblog.yourdomain.tld
</code></pre>
          </li>
          <li>Create a file called CNAME with a content like this: <br />
         yourblog.yourdomain.tld</li>
          <li>Edit your DNS provider configuration to point to your github pages. <br />
  There’re several options for this which are detailed here: <br />
  <a href="https://help.github.com/articles/about-custom-domains-for-github-pages-sites/">https://help.github.com/articles/about-custom-domains-for-github-pages-sites/</a> <br />
  For me, using 1&amp;1 as a domain provider (a pretty bad one IMHO, i wouldn’t recommend it), I set up the only A record that I can edit to point to “192.30.252.153” (or “192.30.252.153”) as stated here: <br />
  <a href="https://help.github.com/articles/tips-for-configuring-an-a-record-with-your-dns-provider/">https://help.github.com/articles/tips-for-configuring-an-a-record-with-your-dns-provider/</a> <br />
  So thanks to this poor configuration options, I loose DNS HA and load balancing… thanks 1&amp;1… &gt;_&lt;”</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p>Config</p>

    <p>Edit the _config.yml file:</p>

    <pre><code>  title : Technical Notes
  tagline: To keep track about things IT related...
  author :
    name : somename
    email : somename@somemail.tld
    github : someusername
    twitter : someusername
    feedburner : feedname        
</code></pre>

    <p>Comment and fill as suited for your configuration.  <br />
  For example, to use disqus as comment solution:</p>

    <pre><code>  comments :
    provider : disqus
    disqus :
      short_name : technotesbillantbzh
</code></pre>
  </li>
  <li>
    <p>Homepage</p>

    <p>Let’s make the homepage more blog like by displaying list of posts. <br />
  Replace the default index.md by index.html containing the following:</p>

    <pre><code>  ---
  layout: default
  ---
    
    
  {% for post in site.posts limit:20 %}
      &lt;div class="blog-index"&gt;
        {% assign post = site.posts.first %}
        {% assign content = post.content %}
        {% include post_detail.html %}
      &lt;/div&gt;
  {% endfor %}
</code></pre>

    <p>Then create the _include/post_detail.html file:</p>

    <pre><code>  &lt;h2 class="entry-title"&gt;
  {% if page.title %}
      &lt;a href="{{ BASE_PATH }}{{ page.url }}"&gt;{{ page.title }}&lt;/a&gt;
  {% endif %}
  {% if post.title %}
      &lt;a href="{{ BASE_PATH }}{{ post.url }}"&gt;{{ post.title }}&lt;/a&gt;
  {% endif %}
  &lt;/h2&gt;
  &lt;div class="entry-content"&gt;{{ content }}&lt;/div&gt;
</code></pre>
  </li>
  <li>
    <p>Create a post</p>

    <pre><code>  rake2.1 post title="Create a blog hosted on Github with Jekyll"
</code></pre>
  </li>
  <li>
    <p>Publish</p>

    <pre><code>  git push origin gh-pages
</code></pre>
  </li>
</ul>

<h2 id="usage">Usage</h2>

<ul>
  <li>
    <p>Change Theme:</p>

    <pre><code>  rake theme:switch name="twitter"
</code></pre>
  </li>
  <li>
    <p>Create a post:</p>

    <pre><code>  rake2.1 post title="Create a blog hosted on Github with Jekyll"
</code></pre>
  </li>
  <li>
    <p>Create a Draft:</p>

    <pre><code>  vi _DRAFTS/newdraft.md
</code></pre>
  </li>
  <li>
    <p>Publish a draft without plugin T_T (because github pages do not support plugins):</p>

    <pre><code>  rake2.1 post title="newpost"   
  cat _DRAFTS/draft_to_publish &gt;&gt; _POSTS/newpost.md   
  rm  _DRAFTS/draft_to_publish   
</code></pre>
  </li>
  <li>
    <p>See changes locally:</p>

    <pre><code>  jekyll serve --host 0.0.0.0
</code></pre>

    <ul>
      <li>
        <p>Also display drafts:</p>

        <pre><code>  jekyll serve --host 0.0.0.0 --drafts
</code></pre>
      </li>
    </ul>
  </li>
</ul>

<p>sources:  <br />
<a href="http://jekyllbootstrap.com/usage/jekyll-quick-start.html">http://jekyllbootstrap.com/usage/jekyll-quick-start.html</a>  <br />
<a href="https://gist.github.com/nimbupani/1421828#file-post_detail-html">https://gist.github.com/nimbupani/1421828#file-post_detail-html</a> <br />
<a href="https://truongtx.me/2012/12/27/jekyll-create-a-list-of-lastest-posts/">https://truongtx.me/2012/12/27/jekyll-create-a-list-of-lastest-posts/</a></p>
</div>

    </div>
  

      </div>
      <hr>
      <footer>
        <p>&copy; 2015 Francois Billant
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>
        </p>
      </footer>

    </div>

    



  </body>
</html>

